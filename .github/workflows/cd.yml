name: CD - Deploy to AWS K8s

on:
  push:
    branches: [ main ]  # åªæœ‰ main åˆ†æ”¯è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:    # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  AWS_REGION: ap-east-2
  ECR_REPOSITORY: my-blog-project
  K8S_NAMESPACE: my-blog-project
  DEPLOYMENT_NAME: my-blog-project

jobs:
  deploy:
    runs-on: self-hosted  # ä½¿ç”¨ self-hosted runner
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ³ Get ECR login token
      id: ecr-login
      run: |
        echo "ç™»å…¥ AWS ECR..."
        aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        echo "âœ… ECR ç™»å…¥æˆåŠŸ"
        
    - name: ğŸ—ï¸ Build and push Docker images
      id: build-images
      env:
        ECR_REGISTRY: 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "å»ºç½® FastAPI æ‡‰ç”¨æ˜ åƒ..."
        docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest .
        
        echo "å»ºç½® Jekyll ç¶²ç«™æ˜ åƒ..."
        docker build -f jekyll-site/Dockerfile.prod -t $ECR_REGISTRY/jekyll-site:$IMAGE_TAG jekyll-site/
        docker build -f jekyll-site/Dockerfile.prod -t $ECR_REGISTRY/jekyll-site:latest jekyll-site/
        
        echo "æ¨é€æ‰€æœ‰æ˜ åƒåˆ° ECR..."
        docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
        docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest
        docker push $ECR_REGISTRY/jekyll-site:$IMAGE_TAG
        docker push $ECR_REGISTRY/jekyll-site:latest
        
        echo "âœ… æ‰€æœ‰æ˜ åƒæ¨é€æˆåŠŸ"
        echo "fastapi-image=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "jekyll-image=$ECR_REGISTRY/jekyll-site:$IMAGE_TAG" >> $GITHUB_OUTPUT
        
    - name: âš™ï¸ Verify kubectl access
      run: |
        echo "æª¢æŸ¥ kubectl é€£æ¥..."
        kubectl version --client
        kubectl cluster-info
        echo "âœ… kubectl é€£æ¥æ­£å¸¸"
        
    - name: ğŸ§¹ Cleanup existing resources
      run: |
        echo "æª¢æŸ¥ä¸¦æ¸…ç†å·²å­˜åœ¨çš„è³‡æº..."
        
        # ä½¿ç”¨æ¸…ç†è…³æœ¬
        if [ -f "scripts/cleanup.sh" ]; then
          echo "ä½¿ç”¨æ¸…ç†è…³æœ¬..."
          ./scripts/cleanup.sh
        else
          echo "æ‰‹å‹•æ¸…ç†è³‡æº..."
          # æª¢æŸ¥ä¸¦åˆªé™¤å‘½åç©ºé–“ï¼ˆé€™æœƒåˆªé™¤å…¶ä¸­çš„æ‰€æœ‰è³‡æºï¼‰
          if kubectl get namespace ${{ env.K8S_NAMESPACE }} >/dev/null 2>&1; then
            echo "åˆªé™¤å‘½åç©ºé–“: ${{ env.K8S_NAMESPACE }}"
            kubectl delete namespace ${{ env.K8S_NAMESPACE }}
            # ç­‰å¾…å‘½åç©ºé–“å®Œå…¨åˆªé™¤
            while kubectl get namespace ${{ env.K8S_NAMESPACE }} >/dev/null 2>&1; do
              echo "ç­‰å¾…å‘½åç©ºé–“åˆªé™¤..."
              sleep 5
            done
          fi
        fi
        
        echo "âœ… è³‡æºæ¸…ç†å®Œæˆ"
        
    - name: ğŸ” Create ECR authentication secret
      run: |
        echo "å‰µå»º ECR èªè­‰ secret..."
        
        # ç¢ºä¿å‘½åç©ºé–“å­˜åœ¨
        kubectl apply -f k8s/namespace.yaml
        
        # å‰µå»º ECR secret
        kubectl create secret docker-registry ecr-secret \
          --docker-server=728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com \
          --docker-username=AWS \
          --docker-password=$(aws ecr get-login-password --region ${{ env.AWS_REGION }}) \
          --docker-email=deploy@myblog.com \
          -n ${{ env.K8S_NAMESPACE }}
        
        echo "âœ… ECR secret å‰µå»ºæˆåŠŸ"
        
    - name: ğŸ¯ Update image tag in Kustomization
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "æ›´æ–° Kustomization ä¸­çš„æ˜ åƒæ¨™ç±¤..."
        cd k8s
        
        # ä½¿ç”¨ kustomize æ›´æ–°æ˜ åƒæ¨™ç±¤
        if command -v kustomize &> /dev/null; then
          kustomize edit set image 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
        else
          # å¦‚æœæ²’æœ‰ kustomizeï¼Œç›´æ¥ä¿®æ”¹ deployment.yaml
          sed -i "s|image:.*|image: 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG|" deployment.yaml
        fi
        
        echo "âœ… æ˜ åƒæ¨™ç±¤æ›´æ–°ç‚º: $IMAGE_TAG"
        
    - name: ğŸ“‹ Deploy Kubernetes resources
      run: |
        echo "éƒ¨ç½² Kubernetes è³‡æº..."
        
        # ä½¿ç”¨å¤šå®¹å™¨é…ç½®éƒ¨ç½²
        if command -v kustomize &> /dev/null; then
          echo "ä½¿ç”¨ Kustomize éƒ¨ç½²å¤šå®¹å™¨é…ç½®..."
          kubectl apply -k k8s/kustomization-multi.yaml
        else
          echo "ä½¿ç”¨ kubectl éƒ¨ç½²å¤šå®¹å™¨é…ç½®..."
          # æŒ‰é †åºæ‡‰ç”¨é…ç½®æ–‡ä»¶
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment-multi.yaml
          kubectl apply -f k8s/service-multi.yaml
        fi
        
        echo "âœ… å¤šå®¹å™¨è³‡æºéƒ¨ç½²å®Œæˆ"
        
    - name: â³ Wait for deployment
      run: |
        echo "ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }} --timeout=300s
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        
    - name: ğŸ“Š Verify deployment
      run: |
        echo "é©—è­‰éƒ¨ç½²ç‹€æ…‹..."
        
        echo "=== Namespace ==="
        kubectl get namespace ${{ env.K8S_NAMESPACE }}
        
        echo ""
        echo "=== Pods ==="
        kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        
        echo ""
        echo "=== Services ==="
        kubectl get services -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        
        echo ""
        echo "=== Deployments ==="
        kubectl get deployments -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        
        echo ""
        echo "=== Service Endpoints ==="
        kubectl get endpoints -n ${{ env.K8S_NAMESPACE }}
        
        echo ""
        echo "ğŸ‰ éƒ¨ç½²é©—è­‰å®Œæˆï¼"
