name: ğŸš€ Deploy Single Container (Jekyll Only)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ap-east-2
  ECR_REPOSITORY: jekyll-site
  K8S_NAMESPACE: my-blog-project
  DEPLOYMENT_NAME: my-blog-project-single

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ”‘ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: ğŸ—ï¸ Build and push Docker image
      id: build-image
      env:
        ECR_REGISTRY: 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "å»ºç½® Jekyll ç¶²ç«™æ˜ åƒ..."
        docker build -f jekyll-site/Dockerfile.ultra-simple -t $ECR_REGISTRY/jekyll-site:$IMAGE_TAG jekyll-site/
        docker build -f jekyll-site/Dockerfile.ultra-simple -t $ECR_REGISTRY/jekyll-site:latest jekyll-site/
        
        echo "ç¢ºä¿ ECR å€‰åº«å­˜åœ¨..."
        aws ecr describe-repositories --repository-names jekyll-site --region ${{ env.AWS_REGION }} || \
        aws ecr create-repository --repository-name jekyll-site --region ${{ env.AWS_REGION }}
        
        echo "æ¨é€ Jekyll æ˜ åƒåˆ° ECR..."
        docker push $ECR_REGISTRY/jekyll-site:$IMAGE_TAG
        docker push $ECR_REGISTRY/jekyll-site:latest
        
        echo "âœ… Jekyll æ˜ åƒæ¨é€æˆåŠŸ"
        echo "jekyll-image=$ECR_REGISTRY/jekyll-site:$IMAGE_TAG" >> $GITHUB_OUTPUT
        
    - name: âš™ï¸ Verify kubectl access
      run: |
        echo "æª¢æŸ¥ kubectl é€£æ¥..."
        kubectl version --client
        kubectl cluster-info
        echo "âœ… kubectl é€£æ¥æ­£å¸¸"
        
    - name: ğŸ” Check current deployment status
      run: |
        echo "ğŸ” æª¢æŸ¥ç•¶å‰éƒ¨ç½²ç‹€æ…‹..."
        
        # ç¢ºä¿å‘½åç©ºé–“å­˜åœ¨
        kubectl apply -f k8s/namespace.yaml
        
        # æª¢æŸ¥ç•¶å‰éƒ¨ç½²æ˜¯å¦å­˜åœ¨
        if kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }} >/dev/null 2>&1; then
          echo "ğŸ“Š ç™¼ç¾ç¾æœ‰éƒ¨ç½²ï¼Œå°‡åŸ·è¡Œæ»¾å‹•æ›´æ–°..."
          echo "=== ç•¶å‰éƒ¨ç½²ç‹€æ…‹ ==="
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== ç•¶å‰ Pod ç‹€æ…‹ ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        else
          echo "ğŸ†• æ²’æœ‰ç¾æœ‰éƒ¨ç½²ï¼Œå°‡å‰µå»ºæ–°éƒ¨ç½²..."
        fi
        
        # å‰µå»º ECR secretï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if ! kubectl get secret ecr-secret -n ${{ env.K8S_NAMESPACE }} >/dev/null 2>&1; then
          echo "ğŸ” å‰µå»º ECR èªè­‰ secret..."
          kubectl create secret docker-registry ecr-secret \
            --docker-server=728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com \
            --docker-username=AWS \
            --docker-password=$(aws ecr get-login-password --region ${{ env.AWS_REGION }}) \
            --docker-email=deploy@myblog.com \
            -n ${{ env.K8S_NAMESPACE }}
          echo "âœ… ECR secret å‰µå»ºæˆåŠŸ"
        else
          echo "âœ… ECR secret å·²å­˜åœ¨"
        fi
        
    - name: ğŸ¯ Update image tag in Kustomization
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "æ›´æ–° Kustomization ä¸­çš„æ˜ åƒæ¨™ç±¤..."
        cd k8s
        
        # ä½¿ç”¨ kustomize æ›´æ–°æ˜ åƒæ¨™ç±¤
        if command -v kustomize &> /dev/null; then
          kustomize edit set image 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/jekyll-site:$IMAGE_TAG
        else
          # å¦‚æœæ²’æœ‰ kustomizeï¼Œç›´æ¥ä¿®æ”¹ deployment-single.yaml
          sed -i "s|image:.*jekyll-site.*|image: 728951503024.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/jekyll-site:$IMAGE_TAG|" deployment-single.yaml
        fi
        
        echo "âœ… æ˜ åƒæ¨™ç±¤æ›´æ–°ç‚º: $IMAGE_TAG"
        
    - name: ğŸ“‹ Deploy Kubernetes resources
      run: |
        echo "éƒ¨ç½² Kubernetes è³‡æº..."
        
        # ä½¿ç”¨å–®å®¹å™¨é…ç½®éƒ¨ç½²
        if command -v kustomize &> /dev/null; then
          echo "ä½¿ç”¨ Kustomize éƒ¨ç½²å–®å®¹å™¨é…ç½®..."
          kubectl apply -k k8s/kustomization-single.yaml
        else
          echo "ä½¿ç”¨ kubectl éƒ¨ç½²å–®å®¹å™¨é…ç½®..."
          # æŒ‰é †åºæ‡‰ç”¨é…ç½®æ–‡ä»¶
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment-single.yaml
          kubectl apply -f k8s/service-single.yaml
        fi
        
        echo "âœ… å–®å®¹å™¨è³‡æºéƒ¨ç½²å®Œæˆ"
        
    - name: â³ Wait for deployment
      run: |
        echo "ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        
        # å…ˆæª¢æŸ¥ Pod ç‹€æ…‹
        echo "=== æª¢æŸ¥ Pod ç‹€æ…‹ ==="
        kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }} -o wide
        
        echo ""
        echo "=== æª¢æŸ¥ Pod äº‹ä»¶ ==="
        kubectl get events -n ${{ env.K8S_NAMESPACE }} --sort-by='.lastTimestamp' | grep -E "(${{ env.DEPLOYMENT_NAME }}|Failed|Error)" | tail -10
        
        echo ""
        echo "=== æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹ ==="
        kubectl describe deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }}
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆï¼Œå¢åŠ è¶…æ™‚æ™‚é–“
        echo ""
        echo "é–‹å§‹ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }} --timeout=600s
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        
    - name: ğŸ¥ Health check
      run: |
        echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."
        
        # ç­‰å¾…æœå‹™å°±ç·’
        echo "â³ ç­‰å¾…æœå‹™å°±ç·’..."
        sleep 15
        
        # æª¢æŸ¥æœå‹™æ˜¯å¦éŸ¿æ‡‰
        echo "ğŸ” æª¢æŸ¥æœå‹™éŸ¿æ‡‰..."
        POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }} -o jsonpath='{.items[0].metadata.name}')
        
        if [ -n "$POD_NAME" ]; then
          echo "ğŸ“Š æ¸¬è©¦ Pod: $POD_NAME"
          
          # æª¢æŸ¥ Pod æ˜¯å¦é‹è¡Œ
          if kubectl get pod $POD_NAME -n ${{ env.K8S_NAMESPACE }} | grep -q "Running"; then
            echo "âœ… Pod ç‹€æ…‹æ­£å¸¸"
            
            # æª¢æŸ¥æœå‹™ç«¯å£
            if kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- curl -s http://localhost:4000/ >/dev/null 2>&1; then
              echo "âœ… æœå‹™å¥åº·æª¢æŸ¥é€šé"
            else
              echo "âš ï¸  æœå‹™å¥åº·æª¢æŸ¥æœªé€šéï¼Œä½† Pod å·²é‹è¡Œ"
            fi
          else
            echo "âŒ Pod ç‹€æ…‹ç•°å¸¸"
            kubectl describe pod $POD_NAME -n ${{ env.K8S_NAMESPACE }}
          fi
        else
          echo "âŒ æ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„ Pod"
        fi
        
    - name: ğŸ“Š Verify deployment
      run: |
        echo "é©—è­‰éƒ¨ç½²ç‹€æ…‹..."
        
        echo "=== Namespace ==="
        kubectl get namespace ${{ env.K8S_NAMESPACE }}
        
        echo ""
        echo "=== Pods ==="
        kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        
        echo ""
        echo "=== Services ==="
        kubectl get services -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        
        echo ""
        echo "=== Deployments ==="
        kubectl get deployments -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
        
        echo ""
        echo "=== Service Endpoints ==="
        kubectl get endpoints -n ${{ env.K8S_NAMESPACE }}
        
        echo ""
        echo "ğŸ‰ éƒ¨ç½²é©—è­‰å®Œæˆï¼"
        echo ""
        echo "ğŸŒ è¨ªå•æ–¹å¼ï¼š"
        echo "   Jekyll ç¶²ç«™: http://[NODE-IP]:30081"
        
    - name: ğŸ”„ Rollback on failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±æ•—ï¼ŒåŸ·è¡Œå›æ»¾..."
        
        if kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }} >/dev/null 2>&1; then
          echo "ğŸ”„ å›æ»¾åˆ°ä¸Šä¸€å€‹ç‰ˆæœ¬..."
          kubectl rollout undo deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }}
          
          echo "â³ ç­‰å¾…å›æ»¾å®Œæˆ..."
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          
          if [ $? -eq 0 ]; then
            echo "âœ… å›æ»¾æˆåŠŸ"
          else
            echo "âŒ å›æ»¾å¤±æ•—ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥"
          fi
        else
          echo "â„¹ï¸  æ²’æœ‰éƒ¨ç½²å¯ä»¥å›æ»¾"
        fi
